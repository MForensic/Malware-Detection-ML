import os

import time

import sys



def startup( path1, path2, name ):



    # stuff to situate the folders, VM, and necessary files.

    #

    # path1 = path to the malware source,

    # path2 = path to the malware destination

    # name = the full path to the vm

    if not os.path.exists(path2):

        print("making directory "+path2)

        os.mkdir(path2)



    for f in os.listdir(path1):

        f2=os.path.join(path2, f)

        f= os.path.join(path1, f)

        os.rename(f, f2)

    

    os.system("vmrun start " + name)

    os.system("vmrun -T ws snapshot " + name + " knownGood")



def handleVM( name, snapName ):



    # name = full path to vm

    # snapName = name of the snapshot we want to create, based off of the malware we ran to create it

    # goodName = name of the known good snapshot which we revert to



    # take a snapshot, power down the vm, then revert to the uninfected snapshot. Change all the 'ws' to 'fusion' if using vmware fusion

    os.system("vmrun -T ws snapshot " + name + " " + snapName)

    os.system("vmrun stop " + name)

    os.system("vmrun -T ws revertToSnapshot " + name + " knownGood")

    os.system("vmrun -T ws start " + name)

     





def main(source, dest, vmpath):



    user = ""

    password = ""



    startup(source, dest, vmpath)



    os.chdir(dest)



    for f in os.listdir(dest):



        temp = os.path.join(dest, f)



        # copy the malware from the host into the guest. Since we needed to copy the file over anyway, now we don't need to mess around with shared folders

        os.system("vmrun -T ws -gu " + user + " -gp " + password + " copyFileFromHostToGuest " + vmpath + " " + temp + " C:\RUNME.exe" )



        # change directories to where the vm is, but I don't think this is needed

        # os.chdir(vmpath)

  

        # this line runs a program with given name inside the vm, in this case it's executing the malware

        os.system("vmrun -T ws -gu " + user + " -gp " + password + " runProgramInGuest " + vmpath + " C:\RUNME.exe")

        

        # wait some amount of time to make it so that the malware has time to act on the VM, can be fiddled with

        time.sleep(5)



        # create the name for the snapshot we're about to make

        snap = f + "snapshot"



        # handle all the "VM stuff," e.g. take snapshot, revert

        handleVM( vmpath, snap)



               

if __name__ == "__main__":



    #source = "thePathToMalwareSourceInHost"

    #dest = "thePathToMalwareDestInHost"

    #vmpath = "thePathToVm"



    source = sys.argv[1]

    dest = sys.argv[2]

    vmpath = sys.argv[3]



    main(source, dest, vmpath)








