import os
import json
import csv
import sys

def  volstuff(snapshot, temp, dest):

	# function that calls our modified psxview on the snapshot we want and outputs it as a json file. Differences between psxmod and psxview are:
	# - the output is in binary, except for the process name and PID
	# - a 'simulation' of malfind is included, so it's noted if a process would be found by malfind
	# - it's probably much more poorly written

    # so we can keep things with the same source organized, we strip the extension from the snapshot and then use that for naming
    snapshot = os.path.splitext(snapshot)[0]
    dump = snapshot + "Psx.json"
    cdump = snapshot + "Psx.csv"
    
    # call the modified psxview on our target snapshot and send the output to a json file
    os.system("python vol.py -f " + temp + " --profile=WinXPSP3x86 psxmod --output=json --output-file=" + dump)

    fj = open(dump, "r")
    jdump = json.load(fj)
    f = open(cdump, "w")
    f.writelines('pslsit, psscan, csrss, session, deskthrd, malfind, bad_lin, bad_ip, ExitTime\n')

    for row in jdump["rows"]:
    	s = str(row).translate(None, '[]')
        f.writelines(s + "\n")

    fj.close()
    f.close()

    os.rename(dump, dest + "/" + dump)
    os.rename(cdump, dest + "/" + cdump)

def main(source, dest, vol):

    # take note of where all the snapshots are kept
    
    os.chdir(vol)
    
    # Parallelize me!
    for snapshot in os.listdir(source):
    	temp = os.path.join(source, snapshot)
        volstuff(snapshot, temp, dest)

if __name__=="__main__":
	source = sys.argv[1]
	dest = sys.argv[2]
	vol = sys.argv[3]
	main(source, dest, vol)
