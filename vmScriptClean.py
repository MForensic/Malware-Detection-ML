import os
import time
import sys
import zipfile

def startup( dest, name , runPath):

    # stuff to situate the folders, VM, and necessary files.
    #
    # dest = path to where to keep the vm snapshots
    # name = the full path to the vm
    if not os.path.exists(dest):
        os.mkdir(dest)
    
    # start up the vm and take a good snapshot that will be our known good starting point
    os.system( runPath + " start " + name)
    os.system(runPath + " -T fusion snapshot " + name + " initial")

def inVm(order, user, password, vmpath, runPath):

    # list of programs that we want to run on our vm in various combinations
    progs = ["start chrome gmail.com", 
    "start cmd.exe", 
    "start C:\WINDOWS\system32\mspaint.exe", 
    "start winword",
    "start notepad.exe", 
    "start chrome facebook.com", 
    "start excel", 
    "start \\\"\\\" \\\"C:\Program Files\Nmap\zenmap.exe\\\"", 
    "start \\\"\\\" \\\"C:\Program Files\Wireshark\wireshark.exe\\\""]

    # treat the number we were passed as a binary string, and see which programs in our list correspond to 1's in the number
    for i in range(0, len(progs)):
        # check if the first digit is a 1, and if so run the ith command
        if order % 2 !=0:
            os.system(runPath +" -T fusion -gu " + user + " -gp " + password + " runScriptInGuest " + vmpath + " -activeWindow \"\" \"" + progs[i] + "\"")

        # shift one bit to the right, getting the next digit in the lowest position
        order = order >> 1

def handleVM( name, snapName, dest, runPath ):

    # name = full path to vm
    # snapName = name of the snapshot we want to create, based off of the set of programs we ran
    # initial = name of the "blank" snapshot

    # take a snapshot, power down the vm, then revert to the blank snapshot. Change all the 'ws' to 'fusion' if using vmware fusion
    print("\ntaking snapshot with name: " + snapName)
    os.system(runPath +" -T fusion snapshot " + name + " " + snapName)
    print("\nstopping vm")
    os.system(runPath + " stop " + name)
    print("\nreverting snap")
    os.system(runPath + " -T fusion revertToSnapshot " + name + " initial")
    os.system(runPath + " -T fusion start " + name)
     


def main(dest, vmpath, vmname):

    # The User name and password to interact with the vm
    user = "golden"
    password = "9korner9"

    # the path to vmrun on whatever machine you're using.
    runPath = "/Applications/VMware\ Fusion.app/Contents/Library/vmrun"

    # magic number to correctly idendify the snapshot files
    magic = 386

    # append the vm's name to the vm's path
    vmname = os.path.join(vmpath, vmname)

    # Make sure everything is in order before continuting
    startup(dest, vmname, runPath)

    # loop though enough numbers to get all combinations of programs running from our list, so from 0 to 2^n for list of length n
    for num in range(0, 999999):
        print("\nmaking image with profile " + bin(num))
  
        # run the set of programs specified by num in the vm
        inVm(num, user, password, vmname, runPath)
        print("\nran script, going to sleep")

        # wait some amount of time to make sure everything is situated in the vm
        time.sleep(10)

        # create the name for the snapshot we're about to make
        snap = bin(num) + "snapshot"
        print("\n" + snap)

        # handle all the "VM stuff," e.g. take snapshot, revert
        handleVM( vmname, snap, dest, runPath)
        
        # snapName is the name of the file generated when taking this snapshot. VMware generates this name in a particular way, so we cunstruct the correct name here
        snapName = "Win-Snapshot" + str(num+magic) + ".vmem"

        # name of the zip file we want to make
        zipName = snap + ".zip"

        # rename the vmem file to the format we want
        old = os.path.join(vmpath, snapName)
        new = os.path.join(vmpath, snap + ".vmem")
        snapName = os.rename(old, new)

        # compress the now correctly named vmem file
        zipName = os.path.join(vmpath, zipName)
        snapZip = zipfile.Zipfile(zipName, 'w')
        snapZip.write(snapName, compress_type=zipfile.ZIP_DEFLATED)
        snapZip.close()
        
        # copy our now compressed file to where we want it, namely dest/snapshot.zip
        newname = os.path.join(dest, snap + ".zip")
        print("\nrenaming " + zipName + " to " + newname)
        if os.path.exists(zipName):
            # this is mac specific because I couldn't get os.rename to move things onto the qnap
            os.system("mv " + zipName + " \"" + newname + "\"")

               
if __name__ == "__main__":

    #dest = "thePathToMalwareDestInHost"
    #vmpath = "thePathToVm"
    #vnname = "theNameOfVM"

    dest = sys.argv[1]
    vmpath = sys.argv[2]
    vmname = sys.argv[3]

    main(dest, vmpath, vmname)