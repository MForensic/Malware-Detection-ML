import os
import time
import sys

def startup( dest, name , runPath):

    # stuff to situate the folders, VM, and necessary files.
    #
    # dest = path to where to keep the vm snapshots
    # name = the full path to the vm
    if not os.path.exists(dest):
        os.mkdir(dest)
    
    os.system( runPath + " start " + name)
    os.system(runPath + " -T fusion snapshot " + name + " initial")

def inVm(order, user, password, vmpath, runPath):
    progs = ["start chrome gmail.com", 
    "start cmd.exe", 
    "start C:\WINDOWS\system32\mspaint.exe", 
    "start winword",
    "start notepad.exe", 
    "start chrome facebook.com", 
    "start excel", 
    "start \\\"\\\" \\\"C:\Program Files\Nmap\zenmap.exe\\\"", 
    "start \\\"\\\" \\\"C:\Program Files\Wireshark\wireshark.exe\\\""]

    for i in range(0, len(progs)):
        if order % 2 !=0:
            os.system(runPath +" -T fusion -gu " + user + " -gp " + password + " runScriptInGuest " + vmpath + " -activeWindow \"\" \"" + progs[i] + "\"")
        order = order >> 1

def handleVM( name, snapName, dest, runPath ):

    # name = full path to vm
    # snapName = name of the snapshot we want to create, based off of the set of programs we ran
    # initial = name of the "blank" snapshot

    # take a snapshot, power down the vm, then revert to the blank snapshot. Change all the 'ws' to 'fusion' if using vmware fusion
    print("\ntaking snapshot with name: " + snapName)
    os.system(runPath +" -T fusion snapshot " + name + " " + snapName)
    print("\nstopping vm")
    os.system(runPath + " stop " + name)
    print("\nreverting snap")
    os.system(runPath + " -T fusion revertToSnapshot " + name + " initial")
    os.system(runPath + " -T fusion start " + name)
     


def main(dest, vmpath, vmname):

    user = "golden"
    password = "9korner9"
    runPath = "/Applications/VMware\ Fusion.app/Contents/Library/vmrun"
    vmname = os.path.join(vmpath, vmname)
    startup(dest, vmname, runPath)

    for num in range(512, 999999):
        print("\nmaking image with profile " + bin(num))
  
        # this line runs a program with given name inside the vm, in this case it's executing the script to run a certain set of programs

        inVm(num, user, password, vmname, runPath)
        print("\nran script, going to sleep")
        # wait some amount of time to make it so that the malware has time to act on the VM, can be fiddled with
        time.sleep(10)

        # create the name for the snapshot we're about to make
        snap = bin(num) + "snapshot"
        resnap = snap
        snap = snap + "2"
        print("\n" + snap)

        # handle all the "VM stuff," e.g. take snapshot, revert
        handleVM( vmname, snap, dest, runPath)

        snapName = "Win-Snapshot" + str(num+386) + ".vmem"
        resnap = resnap + ".vmem"
        newname = os.path.join(dest, resnap)
        snapName = os.path.join(vmpath, snapName)
        print("\nrenaming " + snapName + " to " + newname)
        if os.path.exists(snapName):
            os.system("mv " + snapName + " \"" + newname + "\"")

               
if __name__ == "__main__":

    #dest = "thePathToMalwareDestInHost"
    #vmpath = "thePathToVm"
    #vnname = "theNameOfVM"

    dest = sys.argv[1]
    vmpath = sys.argv[2]
    vmname = sys.argv[3]

    main(dest, vmpath, vmname)



